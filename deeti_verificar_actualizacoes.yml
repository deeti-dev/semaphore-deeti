---
- name: Verificar e instalar atualizações do sistema e das aplicações
  hosts:
    - deeti
  gather_facts: yes
  tasks:
    # Verificar atualizações do sistema
    - name: Verificar atualizações do sistema
      win_updates:
        category_names:
          - SecurityUpdates
          - CriticalUpdates
        state: searched
      register: updates_system

    #Instala as actualizaçoes disponíveis para o sistema
    #- name: Instalar atualizações do sistema
      #win_updates:
        #category_names:
          #- SecurityUpdates
        #state: installed
      #when: updates_system.found_update_count > 0
      #register: installed_updates_system

    # Atualizar todos os pacotes instalados via Chocolatey
    - name: Atualizar todos os pacotes Chocolatey
      win_command: choco upgrade all -y
      register: choco_updates
      ignore_errors: yes  # Ignorar erros, caso algum pacote não seja atualizado

    # Verificar se o winget está disponível
    - name: Verificar se winget está disponível
      win_command: where winget
      register: winget_check
      ignore_errors: yes

     # Listar as atualizações dos pacotes com winget
    - name: Listar pacotes desatualizados com winget
      win_command: winget upgrade
      register: winget_updates
      become: no  # Garantir permissões administrativas
      when: winget_check.rc == 0
      ignore_errors: yes  # Ignorar erros caso o winget não consiga encontrar pacotes

    # Exibir pacotes desatualizados com winget
    - name: Exibir pacotes desatualizados com winget
      debug:
        msg: "Pacotes desatualizados com winget: {{ winget_updates.stdout }}"
      when: winget_updates.stdout != ""

     # Atualizar pacotes com winget
    - name: Atualizar pacotes com winget
      win_command: winget upgrade --all --accept-package-agreements --accept-source-agreements --silent --disable-interactivity --unknown --uninstall-previous
      register: winget_upgrade
      when: winget_updates.stdout != ""  # Só faz upgrade se houver pacotes desatualizados
      ignore_errors: yes  # Ignorar erros caso o winget não consiga encontrar pacotes

    # Exibir as atualizações instaladas
    - name: Exibir as atualizações instaladas
      debug:
        msg:
          - "Atualizações instaladas: {{ installed_updates_system }}"
      when: installed_updates_system is defined

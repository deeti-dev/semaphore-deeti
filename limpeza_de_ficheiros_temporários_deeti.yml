---
- name: Limpar arquivos temporários no %temp% e obter o tamanho da pasta
  hosts:
    - deeti
  gather_facts: yes
  ignore_unreachable: yes  # Ignorar hosts inacessíveis
  tasks:
    - name: Obter caminho do diretório %temp%
      win_shell: |
        $tempPath = [System.IO.Path]::GetTempPath()
        $tempPath.Trim()
      register: temp_directory
      ignore_errors: yes

    - name: Calcular o tamanho da pasta %temp% em GB
      win_shell: |
        $tempDir = "{{ temp_directory.stdout }}";
        $totalSize = (Get-ChildItem -Path $tempDir -Recurse | Measure-Object -Property Length -Sum).Sum
        [math]::round($totalSize / 1GB, 2)
      register: temp_size_gb
      ignore_errors: yes

    - name: Exibir o tamanho da pasta %temp%
      debug:
        msg: "Tamanho da pasta %temp%: {{ temp_size_gb.stdout }} GB"

    - name: Deletar arquivos no diretório %temp%
      win_shell: |
        $tempDir = "{{ temp_directory.stdout }}";
        Get-ChildItem -Path $tempDir -Recurse | Remove-Item -Force -ErrorAction SilentlyContinue
      ignore_errors: yes

    - name: Informar se o diretório %temp% foi limpo
      debug:
        msg: "Os arquivos na pasta %temp% foram excluídos com sucesso."

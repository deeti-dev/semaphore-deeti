---
- name: Verificar e instalar atualizações do sistema e das aplicações
  hosts:
    - deeti
  gather_facts: yes
  tasks:
    # Verificar atualizações do sistema
    - name: Verificar atualizações do sistema
      win_updates:
        category_names:
          - SecurityUpdates
        state: searched
      register: updates_system

    #Instala as actualizaçoes disponíveis para o sistema
    #- name: Instalar atualizações do sistema
      #win_updates:
        #category_names:
          #- SecurityUpdates
        #state: installed
      #when: updates_system.found_update_count > 0
      #register: installed_updates_system

    # Atualizar todos os pacotes instalados via Chocolatey
    - name: Atualizar todos os pacotes Chocolatey
      win_command: choco upgrade all -y
      register: choco_updates
      ignore_errors: yes  # Ignorar erros, caso algum pacote não seja atualizado

    # Verificar se o winget está disponível
    - name: Verificar se winget está disponível
      win_command: where winget
      register: winget_check
      ignore_errors: yes

     # Listar as atualizações dos pacotes com winget
    - name: Listar pacotes desatualizados com winget
      win_command: winget upgrade --accept-package-agreements --accept-package-agreements -h --disable-interactivity
      register: winget_updates
      become: no  # Garantir permissões administrativas
      when: winget_check.rc == 0
      ignore_errors: yes  # Ignorar erros caso o winget não consiga encontrar pacotes

    # Exibir pacotes desatualizados com winget
    - name: Exibir pacotes desatualizados com winget
      debug:
        msg: "Pacotes desatualizados com winget: {{ winget_updates.stdout }}"
      when: winget_updates.stdout != ""

     # Atualizar pacotes com winget
    #- name: Atualizar pacotes com winget
      #win_command: winget upgrade --all --accept-package-agreements --accept-package-agreements -h --disable-interactivity
      #register: winget_upgrade
      #become: yes  # Garantir permissões administrativas
      #when: winget_updates.stdout != ""  # Só faz upgrade se houver pacotes desatualizados
      #ignore_errors: yes  # Ignorar erros caso o winget não consiga encontrar pacotes

    # Exibir as atualizações instaladas
    - name: Exibir as atualizações instaladas
      debug:
        msg:
          - "Atualizações instaladas: {{ installed_updates_system }}"
      when: installed_updates_system is defined

    #Verifica se um reboot nas máquinas é necessário
    #- name: Verificar se é necessário reboot
      #win_reboot:
        #reboot_timeout: 600  # Aguarda até 10 minutos
        #test_command: "echo Reboot needed"
      #when: updates_system.reboot_required == true
      #register: reboot_required

    #Informa se um reboot é necessário após as actualizações
    #- name: Informar se o reboot é necessário
      #debug:
        #msg: "Reboot necessário após as atualizações"
      #when: reboot_required.changed == true

    # Reboot se necessário após as atualizações do sistema
    #- name: Reboot se necessário
      #win_reboot:
      #when: updates_system.reboot_required
